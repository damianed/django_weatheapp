from django.shortcuts import render
import requests
from .models import City
from .forms import CityForm
import time

# Create your views here.
def index(request):
    url= 'http://api.openweathermap.org/data/2.5/weather?lat={}&lon={}&units=metric&appid=a37ca4bee258beb72cf54b2b5cf190f3'
    city = "Las Vegas"
    city_weather = ""
    if request.method == 'POST': #only true if form is submited
        # form = CityForm(request.POST)
        # form.save() # will validate and save if validate
        print(request.POST.items());
        city_weather = requests.get(url.format(request.POST["lat"], request.POST["lon"])).json()
    else:
        url= 'http://api.openweathermap.org/data/2.5/weather?q={}&units=metric&appid=a37ca4bee258beb72cf54b2b5cf190f3'
        city_weather = requests.get(url.format(city)).json()

    # form = CityForm()
    weather_data = []
    # for city in cities:
    #
    #     city_weather = requests.get(url.format(city)).json() #request the  API data and convert the JSON to Python data types
    #w
    #     weather = {
    #         'city': city,
    #         'temperature': city_weather['main']['temp'],
    #         'description': city_weather['weather'][0]['description'],
    #         'icon': city_weather['weather'][0]['icon'],
    #     }
    #
    #     weather_data.append(weather)

    weather = {
        'city': city_weather['name'],
        'temperature': city_weather['main']['temp'],
        'description': city_weather['weather'][0]['description'],
        'lat': city_weather['coord']['lat'],
        'lon': city_weather['coord']['lon'],
        'icon': city_weather['weather'][0]['icon'],
    }
    context = weather
    return render(request, 'weatherapp/index.html', context) #returns the index.html template

def forecast(request):
    url = "http://api.openweathermap.org/data/2.5/forecast?lat={}&lon={}&units=metric&appid=a37ca4bee258beb72cf54b2b5cf190f3"
    city_forecast = requests.get(url.format(request.GET['lat'], request.GET['lon'])).json()
    # city_forecast = {"cod":"200","message":0.0032,"cnt":40,"list":[{"dt":1547424000,"main":{"temp":283.14,"temp_min":283.14,"temp_max":284.855,"pressure":851.4,"sea_level":1029.73,"grnd_level":851.4,"humidity":70,"temp_kf":-1.72},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.43,"deg":263.504},"sys":{"pod":"n"},"dt_txt":"2019-01-14 00:00:00"},{"dt":1547434800,"main":{"temp":276.59,"temp_min":276.59,"temp_max":277.878,"pressure":852.79,"sea_level":1033.71,"grnd_level":852.79,"humidity":70,"temp_kf":-1.29},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02n"}],"clouds":{"all":8},"wind":{"speed":0.67,"deg":246.503},"sys":{"pod":"n"},"dt_txt":"2019-01-14 03:00:00"},{"dt":1547445600,"main":{"temp":274.64,"temp_min":274.64,"temp_max":275.499,"pressure":853.26,"sea_level":1035.68,"grnd_level":853.26,"humidity":70,"temp_kf":-0.86},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":56},"wind":{"speed":0.76,"deg":134.502},"sys":{"pod":"n"},"dt_txt":"2019-01-14 06:00:00"},{"dt":1547456400,"main":{"temp":273.76,"temp_min":273.76,"temp_max":274.19,"pressure":853.4,"sea_level":1036.78,"grnd_level":853.4,"humidity":72,"temp_kf":-0.43},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":20},"wind":{"speed":0.22,"deg":98.5014},"sys":{"pod":"n"},"dt_txt":"2019-01-14 09:00:00"},{"dt":1547467200,"main":{"temp":272.548,"temp_min":272.548,"temp_max":272.548,"pressure":853.55,"sea_level":1037.43,"grnd_level":853.55,"humidity":77,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":12},"wind":{"speed":0.17,"deg":300},"sys":{"pod":"n"},"dt_txt":"2019-01-14 12:00:00"},{"dt":1547478000,"main":{"temp":272.312,"temp_min":272.312,"temp_max":272.312,"pressure":854.64,"sea_level":1038.72,"grnd_level":854.64,"humidity":76,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02d"}],"clouds":{"all":8},"wind":{"speed":0.42,"deg":196.506},"sys":{"pod":"d"},"dt_txt":"2019-01-14 15:00:00"},{"dt":1547488800,"main":{"temp":283.282,"temp_min":283.282,"temp_max":283.282,"pressure":855.13,"sea_level":1035.56,"grnd_level":855.13,"humidity":80,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":12},"wind":{"speed":1.31,"deg":182.001},"sys":{"pod":"d"},"dt_txt":"2019-01-14 18:00:00"},{"dt":1547499600,"main":{"temp":285.965,"temp_min":285.965,"temp_max":285.965,"pressure":853.17,"sea_level":1031.16,"grnd_level":853.17,"humidity":72,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":32},"wind":{"speed":1.84,"deg":55.0107},"sys":{"pod":"d"},"dt_txt":"2019-01-14 21:00:00"},{"dt":1547510400,"main":{"temp":283.769,"temp_min":283.769,"temp_max":283.769,"pressure":853.33,"sea_level":1031.98,"grnd_level":853.33,"humidity":73,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":20},"wind":{"speed":1.18,"deg":36.0047},"sys":{"pod":"n"},"dt_txt":"2019-01-15 00:00:00"},{"dt":1547521200,"main":{"temp":277.999,"temp_min":277.999,"temp_max":277.999,"pressure":854.39,"sea_level":1035.69,"grnd_level":854.39,"humidity":88,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":68},"wind":{"speed":1.16,"deg":331},"sys":{"pod":"n"},"dt_txt":"2019-01-15 03:00:00"},{"dt":1547532000,"main":{"temp":276.239,"temp_min":276.239,"temp_max":276.239,"pressure":854.42,"sea_level":1037.05,"grnd_level":854.42,"humidity":86,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":68},"wind":{"speed":0.96,"deg":229.001},"sys":{"pod":"n"},"dt_txt":"2019-01-15 06:00:00"},{"dt":1547542800,"main":{"temp":275.738,"temp_min":275.738,"temp_max":275.738,"pressure":853.51,"sea_level":1036.62,"grnd_level":853.51,"humidity":83,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":68},"wind":{"speed":1.32,"deg":175.002},"sys":{"pod":"n"},"dt_txt":"2019-01-15 09:00:00"},{"dt":1547553600,"main":{"temp":274.977,"temp_min":274.977,"temp_max":274.977,"pressure":853.26,"sea_level":1036.95,"grnd_level":853.26,"humidity":82,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":48},"wind":{"speed":1.07,"deg":226.5},"sys":{"pod":"n"},"dt_txt":"2019-01-15 12:00:00"},{"dt":1547564400,"main":{"temp":274.06,"temp_min":274.06,"temp_max":274.06,"pressure":854.22,"sea_level":1038.05,"grnd_level":854.22,"humidity":79,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.41,"deg":214.001},"sys":{"pod":"d"},"dt_txt":"2019-01-15 15:00:00"},{"dt":1547575200,"main":{"temp":283.979,"temp_min":283.979,"temp_max":283.979,"pressure":854.52,"sea_level":1034.32,"grnd_level":854.52,"humidity":84,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.66,"deg":349.502},"sys":{"pod":"d"},"dt_txt":"2019-01-15 18:00:00"},{"dt":1547586000,"main":{"temp":286.307,"temp_min":286.307,"temp_max":286.307,"pressure":851.98,"sea_level":1029.55,"grnd_level":851.98,"humidity":75,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":0},"wind":{"speed":2.01,"deg":31.5034},"rain":{"3h":0.015},"sys":{"pod":"d"},"dt_txt":"2019-01-15 21:00:00"},{"dt":1547596800,"main":{"temp":284.455,"temp_min":284.455,"temp_max":284.455,"pressure":852.57,"sea_level":1030.47,"grnd_level":852.57,"humidity":74,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":56},"wind":{"speed":1.12,"deg":26.5007},"rain":{"3h":0.06},"sys":{"pod":"n"},"dt_txt":"2019-01-16 00:00:00"},{"dt":1547607600,"main":{"temp":279.472,"temp_min":279.472,"temp_max":279.472,"pressure":853.38,"sea_level":1033.71,"grnd_level":853.38,"humidity":88,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":32},"wind":{"speed":0.96,"deg":314.502},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-16 03:00:00"},{"dt":1547618400,"main":{"temp":277.111,"temp_min":277.111,"temp_max":277.111,"pressure":853.91,"sea_level":1035.54,"grnd_level":853.91,"humidity":86,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02n"}],"clouds":{"all":8},"wind":{"speed":1.36,"deg":201.502},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-16 06:00:00"},{"dt":1547629200,"main":{"temp":275.363,"temp_min":275.363,"temp_max":275.363,"pressure":853.83,"sea_level":1036.18,"grnd_level":853.83,"humidity":84,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.31,"deg":215.001},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-16 09:00:00"},{"dt":1547640000,"main":{"temp":274.227,"temp_min":274.227,"temp_max":274.227,"pressure":853.69,"sea_level":1036.42,"grnd_level":853.69,"humidity":81,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.33,"deg":219.501},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-16 12:00:00"},{"dt":1547650800,"main":{"temp":274.519,"temp_min":274.519,"temp_max":274.519,"pressure":854.5,"sea_level":1037.39,"grnd_level":854.5,"humidity":79,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.41,"deg":195.501},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-16 15:00:00"},{"dt":1547661600,"main":{"temp":285.178,"temp_min":285.178,"temp_max":285.178,"pressure":854.92,"sea_level":1033.67,"grnd_level":854.92,"humidity":87,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.62,"deg":216.501},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-16 18:00:00"},{"dt":1547672400,"main":{"temp":288.043,"temp_min":288.043,"temp_max":288.043,"pressure":852.3,"sea_level":1029.01,"grnd_level":852.3,"humidity":73,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02d"}],"clouds":{"all":8},"wind":{"speed":0.62,"deg":37.0026},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-16 21:00:00"},{"dt":1547683200,"main":{"temp":285.906,"temp_min":285.906,"temp_max":285.906,"pressure":852.54,"sea_level":1029.73,"grnd_level":852.54,"humidity":63,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":8},"wind":{"speed":2.81,"deg":259.501},"rain":{"3h":0.07},"sys":{"pod":"n"},"dt_txt":"2019-01-17 00:00:00"},{"dt":1547694000,"main":{"temp":279.807,"temp_min":279.807,"temp_max":279.807,"pressure":853.66,"sea_level":1033.32,"grnd_level":853.66,"humidity":67,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":2.41,"deg":235.502},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-17 03:00:00"},{"dt":1547704800,"main":{"temp":276.114,"temp_min":276.114,"temp_max":276.114,"pressure":854.39,"sea_level":1035.63,"grnd_level":854.39,"humidity":79,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.51,"deg":244.007},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-17 06:00:00"},{"dt":1547715600,"main":{"temp":274.508,"temp_min":274.508,"temp_max":274.508,"pressure":854.14,"sea_level":1036.11,"grnd_level":854.14,"humidity":77,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.71,"deg":223.507},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-17 09:00:00"},{"dt":1547726400,"main":{"temp":273.22,"temp_min":273.22,"temp_max":273.22,"pressure":853.92,"sea_level":1036.65,"grnd_level":853.92,"humidity":76,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":0.72,"deg":253},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-17 12:00:00"},{"dt":1547737200,"main":{"temp":273.392,"temp_min":273.392,"temp_max":273.392,"pressure":855.11,"sea_level":1038.21,"grnd_level":855.11,"humidity":75,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.06,"deg":327.002},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-17 15:00:00"},{"dt":1547748000,"main":{"temp":283.973,"temp_min":283.973,"temp_max":283.973,"pressure":855.5,"sea_level":1034.42,"grnd_level":855.5,"humidity":80,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.42,"deg":164.003},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-17 18:00:00"},{"dt":1547758800,"main":{"temp":286.75,"temp_min":286.75,"temp_max":286.75,"pressure":853.4,"sea_level":1030.31,"grnd_level":853.4,"humidity":70,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.67,"deg":350.002},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-17 21:00:00"},{"dt":1547769600,"main":{"temp":284.775,"temp_min":284.775,"temp_max":284.775,"pressure":853.38,"sea_level":1030.62,"grnd_level":853.38,"humidity":72,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.3,"deg":341.502},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-18 00:00:00"},{"dt":1547780400,"main":{"temp":277.893,"temp_min":277.893,"temp_max":277.893,"pressure":854.52,"sea_level":1034.67,"grnd_level":854.52,"humidity":81,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.17,"deg":355.501},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-18 03:00:00"},{"dt":1547791200,"main":{"temp":274.947,"temp_min":274.947,"temp_max":274.947,"pressure":854.01,"sea_level":1035.48,"grnd_level":854.01,"humidity":82,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.56,"deg":161.502},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-18 06:00:00"},{"dt":1547802000,"main":{"temp":273.561,"temp_min":273.561,"temp_max":273.561,"pressure":852.51,"sea_level":1034.51,"grnd_level":852.51,"humidity":78,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.21,"deg":188.502},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-18 09:00:00"},{"dt":1547812800,"main":{"temp":272.779,"temp_min":272.779,"temp_max":272.779,"pressure":851.37,"sea_level":1033.74,"grnd_level":851.37,"humidity":76,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.26,"deg":200.001},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-01-18 12:00:00"},{"dt":1547823600,"main":{"temp":273.077,"temp_min":273.077,"temp_max":273.077,"pressure":851.73,"sea_level":1033.75,"grnd_level":851.73,"humidity":74,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.27,"deg":186.5},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-18 15:00:00"},{"dt":1547834400,"main":{"temp":285.918,"temp_min":285.918,"temp_max":285.918,"pressure":850.43,"sea_level":1027.85,"grnd_level":850.43,"humidity":69,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":3.22,"deg":227.504},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-18 18:00:00"},{"dt":1547845200,"main":{"temp":287.853,"temp_min":287.853,"temp_max":287.853,"pressure":847.18,"sea_level":1022.47,"grnd_level":847.18,"humidity":55,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":6.82,"deg":250.002},"rain":{},"sys":{"pod":"d"},"dt_txt":"2019-01-18 21:00:00"}],"city":{"id":590004540,"name":"Nuevo Casas Grandes","coord":{"lat":29.9213,"lon":-107.5191},"country":"MX"}}


    weather_forecast = [{"city": city_forecast['city']['name']}]
    for weather in city_forecast['list']:
        datetime = time.strftime('%b %d %I:%M:%S %p', time.localtime(weather['dt']))
        day = {
            'dt': datetime,
            'description': weather['weather'][0]['description'],
            'icon': weather['weather'][0]['icon'],
            'main': weather['weather'][0]['main'],
            'temperature': {
                'min': weather['main']['temp_min'],
                'max': weather['main']['temp_max'],
            },
        }
        weather_forecast.append(day)

    context = {'weather_forecast': weather_forecast}
    return render(request, 'weatherapp/forecast.html', context)
